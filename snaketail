#!/bin/bash
# snaketail — run Snakemake, auto-fix errors with Claude Code, repeat until done
# Usage: ./snaketail.sh [--max-retries N] [--branch NAME] [snakemake args...]
set -uo pipefail

CHILD_PID=""
trap 'echo "Interrupted."; [ -n "$CHILD_PID" ] && kill -9 "$CHILD_PID" 2>/dev/null; exit 1' INT TERM

DIR="$PWD"
MAX_RETRIES=10
BRANCH="snaketail/$(date '+%Y%m%d-%H%M%S')"
PASS=()

while [ $# -gt 0 ]; do
  case "$1" in
    --max-retries) MAX_RETRIES="$2"; shift 2 ;;
    --branch)      BRANCH="$2";      shift 2 ;;
    *)             PASS+=("$1");     shift ;;
  esac
done

run_snakemake() {
  snakemake --unlock 2>/dev/null
  snakemake "${PASS[@]}" 2>&1 | tee "$DIR/.snaketail_run.log" & CHILD_PID=$!
  wait "$CHILD_PID"; local exit=$?; CHILD_PID=""
  return $exit
}

heal() {
  local error
  error=$(grep -E "Error|Traceback" "$DIR/.snaketail_run.log" -B3 -A10 2>/dev/null | tail -60)
  [ -z "$error" ] && error=$(tail -60 "$DIR/.snaketail_run.log")
  claude -p "Fix the Snakemake error below. Edit the code, then git add and commit. Do not restart Snakemake.
Project: $DIR

$error" \
    --allowedTools "Bash,Read,Edit,Write,Grep,Glob,WebFetch,WebSearch" \
    --dangerously-skip-permissions & CHILD_PID=$!
  wait "$CHILD_PID"; CHILD_PID=""
}

# ── main ──────────────────────────────────────────────────────────────────────
cd "$DIR"
current=$(git branch --show-current 2>/dev/null)
if [[ "$current" != snaketail/* ]]; then
  git checkout -b "$BRANCH"
  current="$BRANCH"
fi
echo "Starting on branch $current"

for attempt in $(seq 1 $MAX_RETRIES); do
  run_snakemake && { echo "Pipeline complete."; git log --oneline "$current"; exit 0; }
  echo "Attempt $attempt/$MAX_RETRIES failed — healing..."
  heal
done

echo "Giving up after $MAX_RETRIES attempts."
exit 1
